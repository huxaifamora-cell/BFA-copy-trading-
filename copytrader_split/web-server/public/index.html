<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>CopyTrader â€” Auto MT5 Copy Trading</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#06090d;--s1:#0b1118;--s2:#101820;--s3:#162030;
  --border:#1c2d3f;--border2:#243a50;
  --accent:#0ea5e9;--accent2:#38bdf8;
  --green:#22d3a0;--red:#f43f5e;--gold:#fbbf24;--orange:#fb923c;--purple:#a78bfa;
  --muted:#3a5570;--muted2:#5a7a95;--text:#94b4c8;--head:#e2f0fa;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app{min-height:100vh;display:flex;flex-direction:column}
.screen{display:none;flex:1;flex-direction:column}
.screen.active{display:flex}

/* â”€â”€ VPS Status Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#vps-banner{
  padding:8px 16px;font-size:12px;font-weight:600;
  display:flex;align-items:center;justify-content:space-between;gap:8px;
  border-bottom:1px solid var(--border);
}
#vps-banner.web-only{background:rgba(167,139,250,.07);color:var(--purple);border-color:rgba(167,139,250,.2)}
#vps-banner.vps-ok{background:rgba(34,211,160,.06);color:var(--green);border-color:rgba(34,211,160,.2)}
#vps-banner.vps-disconnected{background:rgba(251,191,36,.06);color:var(--gold);border-color:rgba(251,191,36,.2)}
#vps-banner a{color:inherit;opacity:.7;font-size:11px;text-decoration:none;cursor:pointer}

/* â”€â”€ Auth screens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.auth-wrap{flex:1;display:flex;align-items:center;justify-content:center;padding:20px}
.auth-box{width:100%;max-width:420px}
.brand{text-align:center;margin-bottom:32px}
.brand-icon{width:52px;height:52px;background:linear-gradient(135deg,#0ea5e922,#22d3a022);
  border:1px solid #0ea5e933;border-radius:14px;
  display:inline-flex;align-items:center;justify-content:center;font-size:24px;margin-bottom:12px}
.brand-name{font-size:26px;font-weight:800;color:var(--head);letter-spacing:-.5px}
.brand-tag{font-size:13px;color:var(--muted2);margin-top:3px}
.auth-card{background:var(--s1);border:1px solid var(--border);border-radius:16px;padding:28px}
.auth-title{font-size:20px;font-weight:700;color:var(--head);margin-bottom:6px}
.auth-sub{font-size:13px;color:var(--muted2);margin-bottom:22px;line-height:1.5}
.auth-footer{text-align:center;margin-top:16px;font-size:13px;color:var(--muted2)}
.auth-footer a{color:var(--accent);text-decoration:none;font-weight:600;cursor:pointer}

/* â”€â”€ Main app layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app-header{
  padding:14px 20px;display:flex;align-items:center;justify-content:space-between;
  background:rgba(6,9,13,.97);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200;
}
.app-brand{display:flex;align-items:center;gap:10px}
.app-icon{width:32px;height:32px;background:linear-gradient(135deg,#0ea5e922,#22d3a022);
  border:1px solid #0ea5e933;border-radius:9px;
  display:flex;align-items:center;justify-content:center;font-size:16px}
.app-name{font-size:16px;font-weight:800;color:var(--head)}
.user-pill{display:flex;align-items:center;gap:8px;padding:6px 12px;
  background:var(--s2);border:1px solid var(--border);border-radius:20px;cursor:pointer}
.user-pill-name{font-size:12px;font-weight:600;color:var(--text)}
.user-pill-dot{width:7px;height:7px;border-radius:50%;background:var(--green);box-shadow:0 0 6px var(--green)}

.app-nav{display:flex;border-bottom:1px solid var(--border);background:var(--bg);
  position:sticky;top:61px;z-index:199;overflow-x:auto}
.app-nav::-webkit-scrollbar{display:none}
.nav-btn{flex-shrink:0;padding:13px 16px;background:none;border:none;
  border-bottom:2px solid transparent;color:var(--muted2);
  font-family:'Outfit',sans-serif;font-size:12px;font-weight:700;
  letter-spacing:.4px;text-transform:uppercase;cursor:pointer;transition:all .2s;white-space:nowrap}
.nav-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
.nav-btn:hover:not(.active){color:var(--text)}

.page-body{max-width:700px;margin:0 auto;width:100%;padding:20px}

/* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:14px}
.card:hover{border-color:var(--border2)}
.card-head{font-size:15px;font-weight:700;color:var(--head);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.card-head small{color:var(--muted2);font-weight:400;font-size:12px}

/* â”€â”€ VPS setup card (shown when no VPS connected) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.vps-setup-card{background:rgba(167,139,250,.05);border:1px solid rgba(167,139,250,.2);
  border-radius:14px;padding:20px;margin-bottom:14px}
.vps-setup-title{font-size:15px;font-weight:700;color:var(--purple);margin-bottom:8px;display:flex;align-items:center;gap:8px}
.vps-setup-desc{font-size:13px;color:var(--text);line-height:1.7;margin-bottom:14px}
.vps-steps{counter-reset:vstep;list-style:none;padding:0}
.vps-steps li{counter-increment:vstep;padding:8px 0 8px 32px;position:relative;font-size:12px;color:var(--muted2);line-height:1.6;border-bottom:1px solid rgba(28,45,63,.4)}
.vps-steps li:last-child{border-bottom:none}
.vps-steps li::before{content:counter(vstep);position:absolute;left:0;top:8px;width:22px;height:22px;
  background:rgba(167,139,250,.15);border:1px solid rgba(167,139,250,.3);border-radius:50%;
  display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--purple);
  line-height:22px;text-align:center}
.vps-steps code{background:rgba(0,0,0,.4);padding:1px 6px;border-radius:4px;font-family:'DM Mono',monospace;font-size:11px;color:var(--accent2)}

/* â”€â”€ Forms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.form-group{margin-bottom:14px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
label{display:block;font-size:11px;font-weight:700;color:var(--muted2);
  text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
input,select{width:100%;background:rgba(0,0,0,.4);border:1px solid var(--border);
  border-radius:9px;color:var(--head);font-family:'Outfit',sans-serif;
  font-size:14px;padding:11px 13px;outline:none;transition:border-color .2s}
input:focus,select:focus{border-color:var(--accent)}
input::placeholder{color:var(--muted)}
select option{background:#0b1118}
.input-hint{font-size:11px;color:var(--muted2);margin-top:5px;line-height:1.4}
.toggle-row{display:flex;justify-content:space-between;align-items:center;
  padding:11px 0;border-bottom:1px solid rgba(28,45,63,.5)}
.toggle-row:last-child{border-bottom:none}
.toggle-info .toggle-lbl{font-size:13px;font-weight:600;color:var(--text)}
.toggle-info .toggle-desc{font-size:11px;color:var(--muted2);margin-top:2px}
.toggle{position:relative;width:42px;height:23px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.toggle-sl{position:absolute;inset:0;background:var(--border2);border-radius:23px;cursor:pointer;transition:.3s}
.toggle-sl::before{content:'';position:absolute;width:17px;height:17px;left:3px;top:3px;
  background:var(--muted2);border-radius:50%;transition:.3s}
.toggle input:checked+.toggle-sl{background:var(--green)}
.toggle input:checked+.toggle-sl::before{transform:translateX(19px);background:#000}

/* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;
  padding:12px 20px;border:none;border-radius:10px;
  font-family:'Outfit',sans-serif;font-size:14px;font-weight:700;
  cursor:pointer;transition:all .2s;letter-spacing:.1px}
.btn-block{width:100%}
.btn-primary{background:linear-gradient(135deg,var(--accent),#0284c7);color:#fff}
.btn-primary:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 4px 20px #0ea5e940}
.btn-success{background:linear-gradient(135deg,var(--green),#059669);color:#000}
.btn-danger{background:rgba(244,63,94,.1);border:1px solid rgba(244,63,94,.3);color:var(--red)}
.btn-outline{background:transparent;border:1px solid var(--border2);color:var(--text)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-ghost{background:transparent;border:none;color:var(--muted2);padding:8px 12px}
.btn-ghost:hover{color:var(--text)}
.btn-purple{background:rgba(167,139,250,.12);border:1px solid rgba(167,139,250,.3);color:var(--purple)}
.btn-sm{padding:7px 14px;font-size:12px;border-radius:8px}
.btn:disabled{opacity:.35;cursor:not-allowed;transform:none!important;box-shadow:none!important}

/* â”€â”€ Alerts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert{padding:11px 14px;border-radius:9px;font-size:13px;margin-bottom:14px;display:none;line-height:1.5}
.alert.show{display:block}
.alert-error{background:rgba(244,63,94,.08);border:1px solid rgba(244,63,94,.25);color:var(--red)}
.alert-success{background:rgba(34,211,160,.08);border:1px solid rgba(34,211,160,.25);color:var(--green)}
.alert-info{background:rgba(14,165,233,.08);border:1px solid rgba(14,165,233,.2);color:var(--accent2)}
.alert-warn{background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.25);color:var(--gold)}

/* â”€â”€ Badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;
  font-size:9px;font-weight:700;letter-spacing:.4px;text-transform:uppercase;
  font-family:'DM Mono',monospace;white-space:nowrap;gap:4px}
.b-buy{background:rgba(34,211,160,.12);color:var(--green);border:1px solid rgba(34,211,160,.2)}
.b-sell{background:rgba(244,63,94,.12);color:var(--red);border:1px solid rgba(244,63,94,.2)}
.b-live{background:rgba(34,211,160,.12);color:var(--green);border:1px solid rgba(34,211,160,.2)}
.b-offline{background:rgba(58,85,112,.2);color:var(--muted2);border:1px solid var(--border)}
.b-running{background:rgba(34,211,160,.12);color:var(--green);border:1px solid rgba(34,211,160,.2)}
.b-starting{background:rgba(251,191,36,.12);color:var(--gold);border:1px solid rgba(251,191,36,.25)}
.b-stopped{background:rgba(58,85,112,.2);color:var(--muted2);border:1px solid var(--border)}
.b-pending_vps{background:rgba(167,139,250,.12);color:var(--purple);border:1px solid rgba(167,139,250,.25)}
.b-stop_requested{background:rgba(251,146,60,.1);color:var(--orange);border:1px solid rgba(251,146,60,.2)}
.b-error{background:rgba(244,63,94,.12);color:var(--red);border:1px solid rgba(244,63,94,.2)}
.b-demo{background:rgba(14,165,233,.1);color:var(--accent2);border:1px solid rgba(14,165,233,.2)}
.b-live-acc{background:rgba(251,191,36,.1);color:var(--gold);border:1px solid rgba(251,191,36,.2)}
.b-master{background:rgba(251,146,60,.1);color:var(--orange);border:1px solid rgba(251,146,60,.2)}
.b-slave{background:rgba(14,165,233,.1);color:var(--accent2);border:1px solid rgba(14,165,233,.2)}
.b-pending{background:rgba(251,191,36,.12);color:var(--gold);border:1px solid rgba(251,191,36,.25)}
.b-approved{background:rgba(34,211,160,.12);color:var(--green);border:1px solid rgba(34,211,160,.2)}
.b-rejected,.b-revoked{background:rgba(244,63,94,.12);color:var(--red);border:1px solid rgba(244,63,94,.2)}
.b-gated{background:rgba(251,146,60,.1);color:var(--orange);border:1px solid rgba(251,146,60,.2)}

/* â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.stats-grid{display:grid;gap:8px;margin-bottom:14px}
.sg-3{grid-template-columns:repeat(3,1fr)}
.sg-4{grid-template-columns:repeat(4,1fr)}
.sg-2{grid-template-columns:repeat(2,1fr)}
.stat-box{background:rgba(0,0,0,.3);border:1px solid var(--border);border-radius:10px;padding:12px 10px;text-align:center}
.sv{font-size:18px;font-weight:800;color:var(--head);font-family:'DM Mono',monospace;line-height:1}
.sv.sm{font-size:14px}
.sv.pos{color:var(--green)}.sv.neg{color:var(--red)}
.sl{font-size:9px;color:var(--muted2);text-transform:uppercase;letter-spacing:.4px;margin-top:4px}

/* â”€â”€ Tables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tbl{width:100%;border-collapse:collapse}
.tbl th{font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);
  padding:8px 6px 6px;text-align:left;border-bottom:1px solid var(--border);font-weight:700}
.tbl td{padding:10px 6px;font-size:12px;border-bottom:1px solid rgba(28,45,63,.5);vertical-align:middle}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:rgba(255,255,255,.02)}
.mono{font-family:'DM Mono',monospace}
.pos{color:var(--green)}.neg{color:var(--red)}

/* â”€â”€ Account cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.account-card{background:var(--s2);border:1px solid var(--border);border-radius:12px;
  padding:16px;margin-bottom:10px;transition:border-color .2s}
.account-card:hover{border-color:var(--border2)}
.ac-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.ac-label{font-size:15px;font-weight:700;color:var(--head)}
.ac-server{font-size:11px;color:var(--muted2);font-family:'DM Mono',monospace;margin-top:2px}
.ac-badges{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px}
.ac-code{font-family:'DM Mono',monospace;font-size:20px;font-weight:600;
  color:var(--accent);letter-spacing:3px;cursor:pointer}
.ac-code-hint{font-size:11px;color:var(--muted2);margin-top:2px}
.ac-actions{display:flex;gap:6px;flex-wrap:wrap}

/* â”€â”€ Channel explore cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ch-card{display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;background:var(--s2);border:1px solid var(--border);
  border-radius:11px;margin-bottom:10px;cursor:pointer;transition:all .2s}
.ch-card:hover{border-color:var(--accent);background:var(--s3);transform:translateX(3px)}
.ch-code-big{font-family:'DM Mono',monospace;font-size:20px;font-weight:600;color:var(--accent);letter-spacing:3px}
.ch-name{font-size:14px;font-weight:700;color:var(--head)}
.ch-meta{font-size:11px;color:var(--muted2);margin-top:2px;font-family:'DM Mono',monospace}

/* â”€â”€ Sub-tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sub-tabs{display:flex;gap:4px;margin-bottom:14px;background:rgba(0,0,0,.3);
  padding:4px;border-radius:9px}
.sub-tab{flex:1;padding:8px;background:transparent;border:none;color:var(--muted2);
  font-family:'Outfit',sans-serif;font-size:12px;font-weight:700;cursor:pointer;
  border-radius:6px;transition:all .2s;text-transform:uppercase;letter-spacing:.3px}
.sub-tab.active{background:var(--s2);color:var(--accent)}

/* â”€â”€ Step wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.steps{display:flex;gap:0;margin-bottom:24px;position:relative}
.steps::before{content:'';position:absolute;top:16px;left:0;right:0;height:1px;background:var(--border);z-index:0}
.step{flex:1;text-align:center;position:relative;z-index:1}
.step-dot{width:32px;height:32px;border-radius:50%;background:var(--s2);
  border:2px solid var(--border);display:inline-flex;align-items:center;
  justify-content:center;font-size:12px;font-weight:700;color:var(--muted2);
  margin-bottom:6px;transition:all .3s}
.step.active .step-dot{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 0 12px #0ea5e960}
.step.done .step-dot{background:var(--green);border-color:var(--green);color:#000}
.step-label{font-size:10px;color:var(--muted2);font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.step.active .step-label{color:var(--accent)}
.step.done .step-label{color:var(--green)}

/* â”€â”€ Mode selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.mode-card{padding:16px;background:rgba(0,0,0,.3);border:2px solid var(--border);
  border-radius:12px;cursor:pointer;transition:all .2s;text-align:center}
.mode-card:hover{border-color:var(--border2)}
.mode-card.selected{border-color:var(--accent);background:rgba(14,165,233,.05)}
.mode-icon{font-size:28px;margin-bottom:8px}
.mode-name{font-size:14px;font-weight:700;color:var(--head)}
.mode-desc{font-size:11px;color:var(--muted2);margin-top:4px;line-height:1.4}

/* â”€â”€ Section label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.section-lbl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;
  color:var(--muted2);margin:18px 0 10px;display:flex;align-items:center;gap:8px}
.section-lbl::after{content:'';flex:1;height:1px;background:var(--border)}

/* â”€â”€ Key box â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.key-box{background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.25);
  border-radius:10px;padding:14px;margin:12px 0}
.key-label{font-size:10px;color:var(--gold);text-transform:uppercase;letter-spacing:.5px;
  margin-bottom:8px;font-weight:700}
.key-val{font-family:'DM Mono',monospace;font-size:22px;letter-spacing:6px;
  color:var(--head);word-break:break-all;text-align:center;padding:8px 0}
.key-warn{font-size:11px;color:var(--muted2);margin-top:8px;line-height:1.5}

/* â”€â”€ Win bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.win-bar{display:flex;height:4px;border-radius:4px;overflow:hidden;margin-top:6px}
.wp{background:var(--green)}.lp{background:var(--red)}

/* â”€â”€ Empty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty{text-align:center;padding:44px 20px;color:var(--muted2);font-size:13px}
.empty-icon{font-size:40px;display:block;margin-bottom:10px;opacity:.4}

/* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  background:var(--s2);border:1px solid var(--accent);color:var(--accent2);
  padding:9px 20px;border-radius:20px;font-size:12px;font-weight:700;
  z-index:999;opacity:0;transition:opacity .3s;pointer-events:none;
  font-family:'DM Mono',monospace;letter-spacing:.3px}
.toast.show{opacity:1}

/* â”€â”€ Pulse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pulse{animation:pulse 1.4s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
</style>
</head>
<body>
<div id="app">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  SCREEN: LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-login" class="screen active">
  <div class="auth-wrap">
    <div class="auth-box">
      <div class="brand">
        <div class="brand-icon">âš¡</div>
        <div class="brand-name">CopyTrader</div>
        <div class="brand-tag">Automated MT5 Copy Trading</div>
      </div>
      <div class="auth-card">
        <div class="auth-title">Welcome back</div>
        <div class="auth-sub">Sign in to manage your copy trading accounts</div>
        <div id="login-alert" class="alert alert-error"></div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="login-email" placeholder="you@example.com" autocomplete="email">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="login-password" placeholder="Your password" autocomplete="current-password"
                 onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <button class="btn btn-primary btn-block" onclick="doLogin()">Sign In â†’</button>
        <div class="auth-footer">Don't have an account? <a onclick="showScreen('signup')">Create one</a></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  SCREEN: SIGNUP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-signup" class="screen">
  <div class="auth-wrap">
    <div class="auth-box">
      <div class="brand">
        <div class="brand-icon">âš¡</div>
        <div class="brand-name">CopyTrader</div>
        <div class="brand-tag">Automated MT5 Copy Trading</div>
      </div>
      <div class="auth-card">
        <div class="auth-title">Create account</div>
        <div class="auth-sub">Connect your MT5 account and start copying trades automatically</div>
        <div id="signup-alert" class="alert"></div>
        <div class="form-group">
          <label>Full Name</label>
          <input type="text" id="signup-name" placeholder="Your name">
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="signup-email" placeholder="you@example.com">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="signup-password" placeholder="At least 8 characters">
        </div>
        <div style="margin-bottom:16px">
          <div style="font-size:11px;color:var(--muted2);line-height:1.6;padding:12px;background:rgba(0,0,0,.3);border-radius:8px;border:1px solid var(--border)">
            âš ï¸ By signing up you agree that your MT5 broker credentials will be securely stored and used to automate trading on your behalf. Use at your own risk.
          </div>
        </div>
        <button class="btn btn-primary btn-block" onclick="doSignup()">Create Account â†’</button>
        <div class="auth-footer">Already have an account? <a onclick="showScreen('login')">Sign in</a></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  SCREEN: MAIN APP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="screen-app" class="screen">

  <!-- VPS Status Banner -->
  <div id="vps-banner" class="web-only" style="display:none">
    <span id="vps-banner-text">âš™ï¸ Web preview mode â€” connect a VPS to enable live MT5 automation</span>
    <span id="vps-banner-sub"></span>
  </div>

  <header class="app-header">
    <div class="app-brand">
      <div class="app-icon">âš¡</div>
      <div class="app-name">CopyTrader</div>
    </div>
    <div class="user-pill" onclick="showUserMenu()">
      <span class="user-pill-dot"></span>
      <span class="user-pill-name" id="user-display">...</span>
      <span style="color:var(--muted2);font-size:12px">â–¾</span>
    </div>
  </header>

  <nav class="app-nav">
    <button class="nav-btn active" onclick="navTo('dashboard',this)">ğŸ“Š Dashboard</button>
    <button class="nav-btn" onclick="navTo('connect',this)">â• Add Account</button>
    <button class="nav-btn" onclick="navTo('explore',this)">ğŸŒ Explore</button>
    <button class="nav-btn" onclick="navTo('channels',this)">ğŸ“¡ My Channels</button>
    <button class="nav-btn" onclick="navTo('vpssetup',this)">ğŸ–¥ VPS Setup</button>
  </nav>

  <!-- â”€â”€ TAB: DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="tab-dashboard" class="page-body">
    <div id="dash-alert" class="alert alert-warn" style="display:none"></div>
    <div id="accounts-section">
      <div class="section-lbl">My MT5 Accounts</div>
      <div id="accounts-list">
        <div class="empty"><span class="empty-icon">ğŸ”—</span>No accounts connected yet.<br>Click "Add Account" to get started.</div>
      </div>
    </div>
    <div id="my-channels-section" style="display:none">
      <div class="section-lbl">My Channels</div>
      <div id="my-channels-list"></div>
    </div>
  </div>

  <!-- â”€â”€ TAB: CONNECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="tab-connect" class="page-body" style="display:none">
    <div class="card">
      <div class="card-head">Connect MT5 Account</div>
      <div class="steps" id="wizard-steps">
        <div class="step active" id="wstep-1"><div class="step-dot">1</div><div class="step-label">Role</div></div>
        <div class="step" id="wstep-2"><div class="step-dot">2</div><div class="step-label">MT5 Login</div></div>
        <div class="step" id="wstep-3"><div class="step-dot">3</div><div class="step-label">Settings</div></div>
        <div class="step" id="wstep-4"><div class="step-dot">4</div><div class="step-label">Done</div></div>
      </div>
      <div id="connect-alert" class="alert"></div>
      <!-- Step 1: Role -->
      <div id="wizard-1">
        <div style="font-size:14px;color:var(--text);margin-bottom:16px">What do you want to do?</div>
        <div class="mode-grid">
          <div class="mode-card" id="mode-master" onclick="selectMode('master')">
            <div class="mode-icon">ğŸ“¤</div>
            <div class="mode-name">Master</div>
            <div class="mode-desc">Publish my trades. Others copy me automatically.</div>
          </div>
          <div class="mode-card" id="mode-slave" onclick="selectMode('slave')">
            <div class="mode-icon">ğŸ“¥</div>
            <div class="mode-name">Follower</div>
            <div class="mode-desc">Copy trades from a channel automatically.</div>
          </div>
        </div>
        <button class="btn btn-primary btn-block" onclick="wizardNext(1)" disabled id="btn-w1">Continue â†’</button>
      </div>
      <!-- Step 2: MT5 Login -->
      <div id="wizard-2" style="display:none">
        <div class="form-group">
          <label>Account Label (for you only)</label>
          <input type="text" id="w-label" placeholder="e.g. My FTMO Demo" value="My Account">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>MT5 Login (Account Number)</label>
            <input type="text" id="w-login" placeholder="12345678">
          </div>
          <div class="form-group">
            <label>MT5 Password</label>
            <input type="password" id="w-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
        </div>
        <div class="form-group">
          <label>Broker Server</label>
          <input type="text" id="w-server" placeholder="e.g. ICMarkets-Demo, XM-Demo01">
          <div class="input-hint">Find in MT5 â†’ File â†’ Open an Account. Exact spelling matters.</div>
        </div>
        <div class="form-group">
          <label>Account Type</label>
          <select id="w-account-type">
            <option value="demo">Demo Account</option>
            <option value="live">Live Account</option>
          </select>
        </div>
        <div style="display:flex;gap:10px">
          <button class="btn btn-outline" style="flex:1" onclick="wizardBack(2)">â† Back</button>
          <button class="btn btn-primary" style="flex:2" onclick="wizardNext(2)">Continue â†’</button>
        </div>
      </div>
      <!-- Step 3: Settings -->
      <div id="wizard-3" style="display:none">
        <div id="slave-settings">
          <div class="form-group">
            <label>Channel Code (from master)</label>
            <input type="text" id="w-channel-code" placeholder="ABC123" maxlength="6"
                   style="font-family:'DM Mono',monospace;font-size:22px;letter-spacing:5px;text-transform:uppercase;text-align:center"
                   oninput="this.value=this.value.toUpperCase()">
          </div>
          <div class="form-group">
            <label>Lot Sizing Mode</label>
            <select id="w-lot-mode" onchange="updateLotFields()">
              <option value="MIRROR">Mirror â€” copy exact lot size</option>
              <option value="FIXED">Fixed â€” always use same lot size</option>
              <option value="BALANCE">Balance Scale â€” proportional to my balance</option>
              <option value="RISK_PCT">Risk % â€” risk X% of balance per trade</option>
            </select>
          </div>
          <div id="lot-fixed-field" class="form-group" style="display:none">
            <label>Fixed Lot Size</label>
            <input type="number" id="w-fixed-lot" value="0.01" step="0.01" min="0.01">
          </div>
          <div id="lot-risk-field" class="form-group" style="display:none">
            <label>Risk % per Trade</label>
            <input type="number" id="w-risk-pct" value="1.0" step="0.1" min="0.1">
          </div>
          <div id="lot-balance-field" class="form-group" style="display:none">
            <label>Master Account Balance ($)</label>
            <input type="number" id="w-master-bal" value="10000" step="1000">
            <div class="input-hint">Enter the master's balance so we can scale lots proportionally.</div>
          </div>
        </div>
        <div id="master-settings" style="display:none">
          <div style="padding:16px;background:rgba(14,165,233,.06);border:1px solid rgba(14,165,233,.2);border-radius:10px;font-size:13px;color:var(--text);line-height:1.7">
            âœ… As a <strong style="color:var(--accent)">Master</strong>, a channel will be created automatically for you.<br>
            Your trades will be published in real-time and you'll get a 6-digit code to share with followers.
          </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:16px">
          <button class="btn btn-outline" style="flex:1" onclick="wizardBack(3)">â† Back</button>
          <button class="btn btn-primary" style="flex:2" onclick="wizardNext(3)">Save Account â†’</button>
        </div>
      </div>
      <!-- Step 4: Done -->
      <div id="wizard-4" style="display:none;text-align:center">
        <div style="font-size:48px;margin-bottom:16px" id="launch-icon">âœ…</div>
        <div style="font-size:17px;font-weight:700;color:var(--head);margin-bottom:8px" id="launch-title">Account saved!</div>
        <div style="font-size:13px;color:var(--muted2);line-height:1.6;margin-bottom:20px" id="launch-msg"></div>
        <div id="launch-channel" style="display:none">
          <div class="key-box">
            <div class="key-label">ğŸ“¡ Your Channel Code â€” share with followers</div>
            <div class="key-val" id="launch-code"></div>
            <div class="key-warn">Followers enter this code on CopyTrader to connect automatically.</div>
          </div>
          <button class="btn btn-outline btn-block" onclick="copyText(document.getElementById('launch-code').textContent)" style="margin-bottom:10px">Copy Code</button>
        </div>
        <div id="launch-vps-note" style="display:none;margin-bottom:16px">
          <div style="padding:14px;background:rgba(167,139,250,.07);border:1px solid rgba(167,139,250,.2);border-radius:10px;font-size:13px;color:var(--purple);line-height:1.7">
            ğŸ–¥ <strong>Next step:</strong> Connect a VPS so MT5 can run automatically.<br>
            Go to the <strong>VPS Setup</strong> tab for instructions.
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-success" style="flex:1" onclick="navTo('dashboard',null);loadDashboard()">View Dashboard â†’</button>
          <button class="btn btn-purple btn-sm" onclick="navTo('vpssetup',null)">ğŸ–¥ VPS Setup</button>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ TAB: EXPLORE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="tab-explore" class="page-body" style="display:none">
    <div id="explore-list">
      <div class="empty"><span class="empty-icon">ğŸŒ</span>Loading channels...</div>
    </div>
    <div id="explore-detail" style="display:none">
      <button class="btn btn-ghost" onclick="closeExploreDetail()" style="margin-bottom:12px">â† Back</button>
      <div id="explore-detail-content"></div>
    </div>
  </div>

  <!-- â”€â”€ TAB: MY CHANNELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="tab-channels" class="page-body" style="display:none">
    <div id="my-channels-detail"></div>
  </div>

  <!-- â”€â”€ TAB: VPS SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="tab-vpssetup" class="page-body" style="display:none">

    <div id="vps-status-card" class="card" style="border-color:rgba(167,139,250,.25)">
      <div class="card-head" style="color:var(--purple)">ğŸ–¥ VPS Connection Status</div>
      <div id="vps-status-content">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px">
          <div id="vps-status-dot" style="width:10px;height:10px;border-radius:50%;background:var(--muted)"></div>
          <div id="vps-status-text" style="font-size:14px;color:var(--muted2)">Checking...</div>
        </div>
      </div>
    </div>

    <div class="vps-setup-card">
      <div class="vps-setup-title">ğŸ“‹ How to connect a VPS (takes ~5 min)</div>
      <div class="vps-setup-desc">
        The web server (Render) handles your accounts and channels.<br>
        A VPS runs MT5 + Wine in the background for each user.<br>
        The VPS agent connects to this web server automatically.
      </div>
      <ol class="vps-steps">
        <li><strong style="color:var(--head)">Get a VPS</strong> â€” Ubuntu 22.04, 4â€“8 GB RAM.
          Recommended: Hetzner CPX31 (~$15/mo), DigitalOcean 4GB, or Vultr.</li>
        <li><strong style="color:var(--head)">SSH into your VPS</strong> and download the VPS agent setup script:
          <br><code>curl -O https://your-render-url.onrender.com/setup-vps.sh</code>
          <br>Or upload the <code>vps-agent/</code> folder from the project files.</li>
        <li><strong style="color:var(--head)">Set your environment variables</strong> on the VPS:
          <br><code>WEB_SERVER_URL=https://your-render-url.onrender.com</code>
          <br><code>VPS_AGENT_SECRET=your-shared-secret</code>
          <br>(Same secret you set on Render as <code>VPS_AGENT_SECRET</code>)</li>
        <li><strong style="color:var(--head)">Run the setup script</strong> on your VPS:
          <br><code>chmod +x setup_vps.sh && sudo bash setup_vps.sh</code>
          <br>This installs Node, Wine, Xvfb, MT5, and starts the agent via PM2.</li>
        <li><strong style="color:var(--head)">Done!</strong> The VPS agent will appear as Connected above.
          Any accounts you've added will automatically start launching.</li>
      </ol>
    </div>

    <div class="card">
      <div class="card-head">Render Environment Variables</div>
      <div style="font-size:13px;color:var(--text);line-height:1.8">
        Set these in your Render dashboard â†’ Service â†’ Environment:
      </div>
      <div style="margin-top:12px;font-family:'DM Mono',monospace;font-size:12px;line-height:2;background:rgba(0,0,0,.4);padding:14px;border-radius:9px;border:1px solid var(--border)">
        <div><span style="color:var(--accent2)">JWT_SECRET</span> = <span style="color:var(--green)">any-long-random-string</span></div>
        <div><span style="color:var(--accent2)">ENCRYPTION_SECRET</span> = <span style="color:var(--green)">32+ char random string</span></div>
        <div><span style="color:var(--accent2)">VPS_AGENT_SECRET</span> = <span style="color:var(--green)">shared-secret-with-vps</span></div>
        <div><span style="color:var(--accent2)">SERVER_URL</span> = <span style="color:var(--green)">https://your-app.onrender.com</span></div>
      </div>
    </div>

    <div class="card">
      <div class="card-head">Full VPS Stack (when you're ready)</div>
      <div style="font-size:13px;color:var(--text);line-height:1.8;margin-bottom:12px">
        Alternatively, you can host everything on one VPS â€” the included <code style="background:rgba(0,0,0,.4);padding:1px 6px;border-radius:4px;font-family:'DM Mono',monospace">setup_vps.sh</code> handles the complete stack (web + MT5). Just skip Render entirely.
      </div>
      <div style="font-family:'DM Mono',monospace;font-size:12px;line-height:2;background:rgba(0,0,0,.4);padding:14px;border-radius:9px;border:1px solid var(--border)">
        <div style="color:var(--muted2)"># One-command full VPS setup</div>
        <div><span style="color:var(--green)">sudo bash setup_vps.sh</span></div>
        <div style="color:var(--muted2)"># Then visit http://YOUR_VPS_IP:3000</div>
      </div>
    </div>

  </div>

</div><!-- /#screen-app -->
</div><!-- /#app -->

<div class="toast" id="toast"></div>

<script>
const API = location.origin + '/api';
let TOKEN = localStorage.getItem('ct_token');
let USER  = null;
let wizardMode = null;
let sysStatus  = { web_only: true, vps_connected: false };

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const $ = id => document.getElementById(id);
function esc(s)  { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }
function now()   { return Math.floor(Date.now()/1000) }
function mono(s) { return `<span class="mono">${s}</span>` }
function pSign(v){ return v > 0 ? '+' : '' }
function pCls(v) { return v > 0 ? 'pos' : v < 0 ? 'neg' : '' }
function timeAgo(ts) {
  if (!ts) return 'never';
  const s = now() - ts;
  if (s < 10)    return 'just now';
  if (s < 60)    return s + 's ago';
  if (s < 3600)  return Math.floor(s/60) + 'm ago';
  if (s < 86400) return Math.floor(s/3600) + 'h ago';
  return Math.floor(s/86400) + 'd ago';
}
function fmtTime(ts) {
  if (!ts) return 'â€”';
  const d = new Date(ts*1000);
  return d.toLocaleDateString()+' '+d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
}
function showToast(msg) {
  const t = $('toast'); t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}
function copyText(txt) { navigator.clipboard.writeText(txt.trim()).then(() => showToast('Copied!')) }

async function api(method, path, body) {
  const opts = { method, headers: { 'Content-Type': 'application/json' } };
  if (TOKEN) opts.headers['Authorization'] = 'Bearer ' + TOKEN;
  if (body)  opts.body = JSON.stringify(body);
  const res  = await fetch(API + path, opts);
  const data = await res.json();
  if (!res.ok) throw new Error(data.error || 'Request failed');
  return data;
}

function showAlert(id, msg, type = 'error') {
  const el = $(id);
  el.textContent = msg;
  el.className = `alert alert-${type} show`;
  setTimeout(() => el.classList.remove('show'), 5000);
}

// â”€â”€ Screens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  $('screen-'+name).classList.add('active');
}

// â”€â”€ VPS Status Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function updateVPSBanner() {
  try {
    sysStatus = await api('GET', '/system/status');
  } catch { return; }

  const banner = $('vps-banner');
  banner.style.display = 'flex';

  if (sysStatus.vps_connected) {
    banner.className = 'vps-ok';
    $('vps-banner-text').textContent = 'âœ… VPS agent connected â€” MT5 automation active';
    $('vps-banner-sub').textContent = 'Last seen: ' + timeAgo(sysStatus.vps_last_seen);
  } else if (!sysStatus.web_only && !sysStatus.vps_connected) {
    banner.className = 'vps-disconnected';
    $('vps-banner-text').textContent = 'âš ï¸ VPS agent disconnected â€” MT5 automation paused';
    $('vps-banner-sub').textContent = sysStatus.vps_last_seen ? 'Last seen: ' + timeAgo(sysStatus.vps_last_seen) : '';
  } else {
    banner.className = 'web-only';
    $('vps-banner-text').textContent = 'âš™ï¸ Web preview mode â€” connect a VPS to enable live MT5 automation';
    $('vps-banner-sub').textContent = '';
  }

  // Update VPS setup tab status dot
  const dot  = $('vps-status-dot');
  const text = $('vps-status-text');
  if (dot && text) {
    if (sysStatus.vps_connected) {
      dot.style.background  = 'var(--green)';
      dot.style.boxShadow   = '0 0 6px var(--green)';
      text.style.color      = 'var(--green)';
      text.textContent      = 'âœ… VPS agent is connected and active';
    } else if (!sysStatus.web_only) {
      dot.style.background = 'var(--gold)';
      text.style.color     = 'var(--gold)';
      text.textContent     = 'âš ï¸ VPS configured but agent not responding (check VPS)';
    } else {
      dot.style.background = 'var(--muted)';
      text.style.color     = 'var(--muted2)';
      text.textContent     = 'â¬œ No VPS connected yet â€” follow the setup steps below';
    }
  }
}

// â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navTo(tab, btn) {
  document.querySelectorAll('.page-body').forEach(p => p.style.display = 'none');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  $('tab-'+tab).style.display = 'block';
  if (btn) btn.classList.add('active');
  else document.querySelectorAll('.nav-btn').forEach(b => {
    if (b.textContent.toLowerCase().includes(tab.replace('vpssetup','vps'))) b.classList.add('active');
  });
  if (tab === 'dashboard') loadDashboard();
  if (tab === 'explore')   loadExplore();
  if (tab === 'channels')  loadMyChannels();
  if (tab === 'vpssetup')  updateVPSBanner();
}

// â”€â”€ User menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showUserMenu() {
  if (confirm('Sign out?')) {
    TOKEN = null; USER = null;
    localStorage.removeItem('ct_token');
    showScreen('login');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin() {
  const email = $('login-email').value.trim();
  const pass  = $('login-password').value;
  if (!email || !pass) { showAlert('login-alert','Enter email and password'); return; }
  try {
    const data = await api('POST', '/auth/login', { email, password: pass });
    TOKEN = data.token; USER = data.user;
    localStorage.setItem('ct_token', TOKEN);
    enterApp();
  } catch (e) { showAlert('login-alert', e.message); }
}

async function doSignup() {
  const name  = $('signup-name').value.trim();
  const email = $('signup-email').value.trim();
  const pass  = $('signup-password').value;
  if (!name || !email || !pass) { showAlert('signup-alert','All fields required'); return; }
  try {
    const data = await api('POST', '/auth/signup', { name, email, password: pass });
    TOKEN = data.token; USER = data.user;
    localStorage.setItem('ct_token', TOKEN);
    enterApp();
  } catch (e) { showAlert('signup-alert', e.message, 'error'); }
}

async function enterApp() {
  if (!USER) {
    try { USER = await api('GET', '/auth/me'); } catch { showScreen('login'); return; }
  }
  $('user-display').textContent = USER.name || USER.email.split('@')[0];
  showScreen('app');
  loadDashboard();
  updateVPSBanner();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard() {
  try {
    const data = await api('GET', '/user/overview');
    renderAccounts(data.accounts);
    renderMyChannelsSummary(data.channels);
  } catch(e) {
    $('dash-alert').textContent = 'Failed to load: ' + e.message;
    $('dash-alert').style.display = 'block';
  }
}

function statusLabel(status) {
  const map = {
    'pending_vps':    'â³ AWAITING VPS',
    'starting':       'ğŸ”„ STARTING',
    'running':        'â— RUNNING',
    'stopped':        'â¹ STOPPED',
    'stop_requested': 'â³ STOPPING',
    'error':          'âŒ ERROR',
  };
  return map[status] || status?.toUpperCase() || 'UNKNOWN';
}

function renderAccounts(accounts) {
  const el = $('accounts-list');
  if (!accounts.length) {
    el.innerHTML = `<div class="empty"><span class="empty-icon">ğŸ”—</span>No accounts connected yet.<br>
      <button class="btn btn-primary btn-sm" style="margin-top:12px" onclick="navTo('connect',null)">Add Account â†’</button></div>`;
    return;
  }
  el.innerHTML = accounts.map(a => {
    const statusBadge = `<span class="badge b-${a.status||'stopped'}">${statusLabel(a.status)}</span>`;
    const modeBadge   = `<span class="badge b-${a.mode}">${a.mode.toUpperCase()}</span>`;
    const typeBadge   = `<span class="badge b-${a.account_type==='live'?'live-acc':'demo'}">${a.account_type.toUpperCase()}</span>`;

    const isPendingVPS = a.status === 'pending_vps';

    return `<div class="account-card">
      <div class="ac-top">
        <div>
          <div class="ac-label">${esc(a.label)}</div>
          <div class="ac-server">${esc(a.server)}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px">
          ${statusBadge}
        </div>
      </div>
      <div class="ac-badges">${modeBadge}${typeBadge}</div>
      ${a.mode === 'master' && a.channel_code ? `
        <div>
          <div class="ac-code" onclick="copyText('${a.channel_code}')">${a.channel_code}</div>
          <div class="ac-code-hint">Your channel code â€” share with followers Â· tap to copy</div>
        </div>` : ''}
      ${a.mode === 'slave' && a.channel_code ? `
        <div style="font-size:12px;color:var(--muted2);margin-bottom:10px">
          Following channel: <span class="mono" style="color:var(--accent)">${a.channel_code}</span>
        </div>` : ''}
      ${isPendingVPS ? `
        <div style="font-size:12px;color:var(--purple);padding:8px 12px;background:rgba(167,139,250,.08);border:1px solid rgba(167,139,250,.2);border-radius:8px;margin-bottom:10px">
          â³ Waiting for VPS connection to launch MT5.
          <a onclick="navTo('vpssetup',null)" style="color:var(--purple);cursor:pointer;text-decoration:underline;margin-left:4px">Set up VPS â†’</a>
        </div>` : ''}
      <div class="ac-actions">
        ${a.status !== 'running' && a.status !== 'starting'
          ? `<button class="btn btn-success btn-sm" onclick="startAccount(${a.id})">â–¶ Start</button>`
          : `<button class="btn btn-outline btn-sm" onclick="stopAccount(${a.id})">â¹ Stop</button>`}
        <button class="btn btn-danger btn-sm" onclick="deleteAccount(${a.id})">ğŸ—‘ Remove</button>
      </div>
    </div>`;
  }).join('');
}

function renderMyChannelsSummary(channels) {
  const sec = $('my-channels-section');
  if (!channels.length) { sec.style.display = 'none'; return; }
  sec.style.display = 'block';
  $('my-channels-list').innerHTML = channels.map(ch => {
    const isLive = (now() - ch.last_active) < 15;
    return `<div class="ch-card" onclick="navTo('channels',null);loadMyChannels()">
      <div>
        <div class="ch-code-big">${ch.code}</div>
        <div class="ch-name">${esc(ch.name)}</div>
        <div class="ch-meta">${ch.open_trades||0} open Â· ${ch.pending_subs||0} pending</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        ${isLive ? '<span class="badge b-live">â— LIVE</span>' : '<span class="badge b-offline">OFFLINE</span>'}
        ${ch.pending_subs > 0 ? `<span class="badge b-pending">${ch.pending_subs} pending</span>` : ''}
      </div>
    </div>`;
  }).join('');
}

async function startAccount(id) {
  try {
    const r = await api('POST', `/mt5/accounts/${id}/start`);
    showToast(r.web_only ? 'Queued â€” connect VPS to launch' : 'Starting...');
    setTimeout(loadDashboard, 1500);
  } catch(e) { showToast('Error: ' + e.message); }
}
async function stopAccount(id) {
  if (!confirm('Stop this MT5 instance?')) return;
  try { await api('POST', `/mt5/accounts/${id}/stop`); showToast('Stop signal sent'); loadDashboard(); }
  catch(e) { showToast('Error: ' + e.message); }
}
async function deleteAccount(id) {
  if (!confirm('Remove this account?')) return;
  try { await api('DELETE', `/mt5/accounts/${id}`); showToast('Removed'); loadDashboard(); }
  catch(e) { showToast('Error: ' + e.message); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONNECT WIZARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectMode(mode) {
  wizardMode = mode;
  document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
  $('mode-'+mode).classList.add('selected');
  $('btn-w1').disabled = false;
}

function wizardStep(n) {
  for (let i = 1; i <= 4; i++) {
    $('wizard-'+i).style.display = i === n ? 'block' : 'none';
    const step = $('wstep-'+i);
    step.className = 'step' + (i < n ? ' done' : i === n ? ' active' : '');
    step.querySelector('.step-dot').textContent = i < n ? 'âœ“' : i;
  }
  if (n === 3) {
    $('slave-settings').style.display  = wizardMode === 'slave'  ? 'block' : 'none';
    $('master-settings').style.display = wizardMode === 'master' ? 'block' : 'none';
  }
}

function wizardNext(current) {
  if (current === 1) {
    if (!wizardMode) return;
    wizardStep(2);
  } else if (current === 2) {
    const login    = $('w-login').value.trim();
    const password = $('w-password').value;
    const server   = $('w-server').value.trim();
    if (!login || !password || !server) { showAlert('connect-alert','All MT5 fields are required','error'); return; }
    wizardStep(3);
  } else if (current === 3) {
    if (wizardMode === 'slave' && !$('w-channel-code').value.trim()) {
      showAlert('connect-alert','Enter the channel code from your master','error'); return;
    }
    saveAccount();
  }
}

function wizardBack(current) { wizardStep(current - 1); }

function updateLotFields() {
  const mode = $('w-lot-mode').value;
  $('lot-fixed-field').style.display   = mode === 'FIXED'   ? 'block' : 'none';
  $('lot-risk-field').style.display    = mode === 'RISK_PCT' ? 'block' : 'none';
  $('lot-balance-field').style.display = mode === 'BALANCE'  ? 'block' : 'none';
}

async function saveAccount() {
  wizardStep(4);
  $('launch-icon').textContent  = 'â³';
  $('launch-title').textContent = 'Saving account...';
  $('launch-msg').textContent   = '';
  $('launch-channel').style.display  = 'none';
  $('launch-vps-note').style.display = 'none';

  const payload = {
    label:        $('w-label').value.trim() || 'My Account',
    login:        $('w-login').value.trim(),
    password:     $('w-password').value,
    server:       $('w-server').value.trim(),
    account_type: $('w-account-type').value,
    mode:         wizardMode,
    channel_code: wizardMode === 'slave' ? $('w-channel-code').value.toUpperCase().trim() : '',
    lot_mode:     wizardMode === 'slave' ? $('w-lot-mode').value : 'MIRROR',
    fixed_lot:    parseFloat($('w-fixed-lot').value) || 0.01,
    risk_pct:     parseFloat($('w-risk-pct').value)  || 1.0,
    master_bal:   parseFloat($('w-master-bal').value)|| 10000,
  };

  try {
    const data = await api('POST', '/mt5/connect', payload);

    if (wizardMode === 'master' && data.channel) {
      $('launch-code').textContent      = data.channel.code;
      $('launch-channel').style.display = 'block';
    }

    $('launch-icon').textContent  = 'âœ…';
    $('launch-title').textContent = 'Account saved!';

    if (data.web_only) {
      $('launch-msg').innerHTML = wizardMode === 'master'
        ? 'Channel created. Your channel code is ready to share.<br><span style="color:var(--purple)">Connect a VPS to start publishing trades automatically.</span>'
        : `Follower account saved for channel <strong style="color:var(--accent)">${payload.channel_code}</strong>.<br><span style="color:var(--purple)">Connect a VPS to start copying trades.</span>`;
      $('launch-vps-note').style.display = 'block';
    } else {
      $('launch-msg').innerHTML = wizardMode === 'master'
        ? 'Your trades will be published automatically. Share your channel code with followers.'
        : `Connecting to channel <strong style="color:var(--accent)">${payload.channel_code}</strong>. Trades will copy automatically.`;
    }
  } catch(e) {
    $('launch-icon').textContent  = 'âŒ';
    $('launch-title').textContent = 'Failed to save';
    $('launch-msg').textContent   = e.message;
    setTimeout(() => wizardStep(2), 2000);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPLORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadExplore() {
  $('explore-list').style.display   = 'block';
  $('explore-detail').style.display = 'none';
  try {
    const data = await api('GET', '/dashboard');
    if (!data.channels.length) {
      $('explore-list').innerHTML = `<div class="empty"><span class="empty-icon">ğŸŒ</span>No public channels yet.</div>`;
      return;
    }
    $('explore-list').innerHTML = data.channels.map(ch => {
      const isLive = (data.server_time - ch.last_active) < 15;
      const total  = (ch.live_profit||0) + (ch.history_profit||0);
      return `<div class="ch-card" onclick="openChannel('${ch.code}')">
        <div>
          <div class="ch-code-big">${ch.code}</div>
          <div class="ch-name">${esc(ch.name)}</div>
          <div class="ch-meta">${ch.open_trades||0} open Â· ${ch.closed_trades||0} closed Â· ${timeAgo(ch.last_active)}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          ${isLive ? '<span class="badge b-live">â— LIVE</span>' : '<span class="badge b-offline">OFFLINE</span>'}
          ${ch.require_sub ? '<span class="badge b-gated">ğŸ”’ APPROVAL</span>' : ''}
          <div class="mono ${pCls(total)}" style="font-size:13px;font-weight:700">${pSign(total)}${total.toFixed(2)}</div>
        </div>
      </div>`;
    }).join('');
  } catch(e) {
    $('explore-list').innerHTML = `<div class="alert alert-error show">${e.message}</div>`;
  }
}

async function openChannel(code) {
  $('explore-list').style.display   = 'none';
  $('explore-detail').style.display = 'block';
  $('explore-detail-content').innerHTML = `<div class="empty"><span class="empty-icon">â³</span>Loading...</div>`;
  try {
    const data = await api('GET', `/dashboard/${code}`);
    renderChannelDetail(data, 'explore-detail-content');
  } catch(e) {
    $('explore-detail-content').innerHTML = `<div class="alert alert-error show">${e.message}</div>`;
  }
}

function closeExploreDetail() {
  $('explore-list').style.display   = 'block';
  $('explore-detail').style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MY CHANNELS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadMyChannels() {
  const el = $('my-channels-detail');
  try {
    const data = await api('GET', '/user/overview');
    if (!data.channels.length) {
      el.innerHTML = `<div class="empty"><span class="empty-icon">ğŸ“¡</span>
        No master channels yet.<br>
        <button class="btn btn-primary btn-sm" style="margin-top:12px" onclick="navTo('connect',null)">Create Channel â†’</button></div>`;
      return;
    }
    el.innerHTML = '';
    for (const ch of data.channels) {
      const full = await api('GET', `/dashboard/${ch.code}`);
      const wrap = document.createElement('div');
      wrap.innerHTML = renderMasterChannelCard(full);
      el.appendChild(wrap);
    }
  } catch(e) {
    el.innerHTML = `<div class="alert alert-error show">${e.message}</div>`;
  }
}

function renderMasterChannelCard(data) {
  const { channel, trades, history, stats } = data;
  const isLive = (now() - channel.last_active) < 15;

  let html = `<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
      <div>
        <div style="font-size:17px;font-weight:700;color:var(--head)">${esc(channel.name)}</div>
        <div style="font-size:11px;color:var(--muted2);margin-top:2px">${esc(channel.description||'')}</div>
      </div>
      ${isLive ? '<span class="badge b-live pulse">â— LIVE</span>' : '<span class="badge b-offline">OFFLINE</span>'}
    </div>

    <div style="margin-bottom:14px">
      <div style="font-size:11px;color:var(--muted2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;font-weight:700">Channel Code</div>
      <div style="font-family:'DM Mono',monospace;font-size:32px;font-weight:600;letter-spacing:8px;color:var(--accent);cursor:pointer" onclick="copyText('${channel.code}')">${channel.code}</div>
      <div style="font-size:11px;color:var(--muted2);margin-top:4px">Share with followers Â· tap to copy</div>
    </div>

    <div class="stats-grid sg-4">
      <div class="stat-box"><div class="sv">${trades.length}</div><div class="sl">Open</div></div>
      <div class="stat-box"><div class="sv">${stats.total}</div><div class="sl">Closed</div></div>
      <div class="stat-box"><div class="sv">${stats.winRate}%</div><div class="sl">Win Rate</div>
        ${stats.total > 0 ? `<div class="win-bar" style="margin-top:5px"><div class="wp" style="width:${stats.winRate}%"></div><div class="lp" style="width:${100-stats.winRate}%"></div></div>` : ''}
      </div>
      <div class="stat-box"><div class="sv ${pCls(stats.totalProfit)}">${pSign(stats.totalProfit)}${stats.totalProfit}</div><div class="sl">P&L</div></div>
    </div>

    <div class="sub-tabs">
      <button class="sub-tab active" onclick="chTab('open','${channel.code}',this)">Open (${trades.length})</button>
      <button class="sub-tab" onclick="chTab('history','${channel.code}',this)">History (${stats.total})</button>
      <button class="sub-tab" onclick="chTab('subs','${channel.code}',this)">Followers</button>
    </div>`;

  html += `<div id="cht-open-${channel.code}">`;
  if (!trades.length) {
    html += `<div class="empty" style="padding:24px"><span class="empty-icon">ğŸ’¤</span>No open positions</div>`;
  } else {
    html += `<div style="overflow-x:auto"><table class="tbl"><thead><tr>
      <th>Symbol</th><th>Dir</th><th>Lots</th><th>Entry</th><th>P&L</th>
    </tr></thead><tbody>`;
    trades.forEach(t => {
      html += `<tr>
        <td style="font-weight:700;color:var(--head)">${t.symbol}</td>
        <td><span class="badge ${t.type===0?'b-buy':'b-sell'}">${t.type===0?'BUY':'SELL'}</span></td>
        <td class="mono">${t.lots}</td>
        <td class="mono" style="font-size:11px">${t.open_price.toFixed(5)}</td>
        <td class="mono ${pCls(t.profit)}" style="font-weight:700">${pSign(t.profit)}${t.profit.toFixed(2)}</td>
      </tr>`;
    });
    html += `</tbody></table></div>`;
  }
  html += `</div>`;

  html += `<div id="cht-history-${channel.code}" style="display:none">`;
  if (!history.length) {
    html += `<div class="empty" style="padding:24px"><span class="empty-icon">ğŸ“‹</span>No history yet</div>`;
  } else {
    html += `<div style="overflow-x:auto"><table class="tbl"><thead><tr>
      <th>Symbol</th><th>Dir</th><th>Lots</th><th>Entry</th><th>Exit</th><th>Pips</th><th>P&L</th><th>Closed</th>
    </tr></thead><tbody>`;
    history.forEach(t => {
      html += `<tr>
        <td style="font-weight:700;color:var(--head)">${t.symbol}</td>
        <td><span class="badge ${t.type===0?'b-buy':'b-sell'}">${t.type===0?'BUY':'SELL'}</span></td>
        <td class="mono">${t.lots}</td>
        <td class="mono" style="font-size:10px">${t.open_price.toFixed(5)}</td>
        <td class="mono" style="font-size:10px">${t.close_price.toFixed(5)}</td>
        <td class="mono ${pCls(t.pips)}">${pSign(t.pips)}${(t.pips||0).toFixed(1)}</td>
        <td class="mono ${pCls(t.profit)}" style="font-weight:700">${pSign(t.profit)}${t.profit.toFixed(2)}</td>
        <td style="font-size:10px;color:var(--muted2)">${fmtTime(t.close_time)}</td>
      </tr>`;
    });
    html += `</tbody></table></div>`;
  }
  html += `</div>`;

  html += `<div id="cht-subs-${channel.code}" style="display:none">
    <div class="empty" style="padding:24px"><span class="empty-icon">â³</span>Loading...</div>
  </div></div>`;

  return html;
}

async function chTab(tab, code, btn) {
  ['open','history','subs'].forEach(t => {
    const el = $(`cht-${t}-${code}`);
    if (el) el.style.display = t === tab ? 'block' : 'none';
  });
  btn.closest('.sub-tabs').querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  if (tab === 'subs') loadSubsForChannel(code);
}

async function loadSubsForChannel(code) {
  const el = $(`cht-subs-${code}`);
  try {
    const data = await api('GET', `/dashboard/${code}`);
    const subs = data.active_slaves || [];
    if (!subs.length) {
      el.innerHTML = `<div class="empty" style="padding:24px"><span class="empty-icon">ğŸ‘¥</span>No active followers right now</div>`;
      return;
    }
    el.innerHTML = subs.map(s => `
      <div style="display:flex;justify-content:space-between;align-items:center;
                  padding:12px;background:var(--s2);border:1px solid var(--border);
                  border-radius:9px;margin-bottom:8px">
        <div>
          <div style="font-size:13px;font-weight:600;color:var(--head)">Follower</div>
          <div style="font-size:10px;color:var(--muted2);font-family:'DM Mono',monospace;margin-top:2px">
            ${s.slave_id.slice(-8)} Â· ${s.lot_mode} Â· ${timeAgo(s.last_seen)}
          </div>
        </div>
        <span class="badge b-approved">â— Active</span>
      </div>`).join('');
  } catch(e) {
    el.innerHTML = `<div class="alert alert-error show">${e.message}</div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHANNEL DETAIL (public explore)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderChannelDetail(data, targetId) {
  const { channel, trades, history, stats, active_slaves } = data;
  const isLive = (now() - channel.last_active) < 15;
  const el = $(targetId);

  let html = `<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px">
      <div>
        <div style="font-size:17px;font-weight:800;color:var(--head)">${esc(channel.name)}</div>
        <div style="font-size:11px;color:var(--muted2);margin-top:2px">${esc(channel.description||'')}</div>
      </div>
      ${isLive ? '<span class="badge b-live">â— LIVE</span>' : '<span class="badge b-offline">OFFLINE</span>'}
    </div>

    <div class="stats-grid sg-4">
      <div class="stat-box"><div class="sv">${trades.length}</div><div class="sl">Open</div></div>
      <div class="stat-box"><div class="sv ${pCls(stats.totalProfit)}">${pSign(stats.totalProfit)}${stats.totalProfit}</div><div class="sl">P&L</div></div>
      <div class="stat-box"><div class="sv">${stats.winRate}%</div><div class="sl">Win Rate</div></div>
      <div class="stat-box"><div class="sv">${active_slaves.length}</div><div class="sl">Following</div></div>
    </div>

    <div class="sub-tabs">
      <button class="sub-tab active" onclick="pubTab('open','${channel.code}',this)">Open (${trades.length})</button>
      <button class="sub-tab" onclick="pubTab('history','${channel.code}',this)">History (${stats.total})</button>
    </div>`;

  html += `<div id="pub-open-${channel.code}">`;
  if (!trades.length) {
    html += `<div class="empty" style="padding:24px"><span class="empty-icon">ğŸ’¤</span>No open positions</div>`;
  } else {
    html += `<div style="overflow-x:auto"><table class="tbl"><thead><tr>
      <th>Symbol</th><th>Dir</th><th>Lots</th><th>Entry</th><th>P&L</th>
    </tr></thead><tbody>`;
    trades.forEach(t => {
      html += `<tr>
        <td style="font-weight:700;color:var(--head)">${t.symbol}</td>
        <td><span class="badge ${t.type===0?'b-buy':'b-sell'}">${t.type===0?'BUY':'SELL'}</span></td>
        <td class="mono">${t.lots}</td>
        <td class="mono" style="font-size:11px">${t.open_price.toFixed(5)}</td>
        <td class="mono ${pCls(t.profit)}" style="font-weight:700">${pSign(t.profit)}${t.profit.toFixed(2)}</td>
      </tr>`;
    });
    html += `</tbody></table></div>`;
  }
  html += `</div>`;

  html += `<div id="pub-history-${channel.code}" style="display:none">`;
  if (!history.length) {
    html += `<div class="empty" style="padding:24px"><span class="empty-icon">ğŸ“‹</span>No history yet</div>`;
  } else {
    html += `<div style="overflow-x:auto"><table class="tbl"><thead><tr>
      <th>Symbol</th><th>Dir</th><th>Pips</th><th>P&L</th><th>Closed</th>
    </tr></thead><tbody>`;
    history.slice(0,100).forEach(t => {
      html += `<tr>
        <td style="font-weight:700;color:var(--head)">${t.symbol}</td>
        <td><span class="badge ${t.type===0?'b-buy':'b-sell'}">${t.type===0?'BUY':'SELL'}</span></td>
        <td class="mono ${pCls(t.pips)}">${pSign(t.pips)}${(t.pips||0).toFixed(1)}</td>
        <td class="mono ${pCls(t.profit)}" style="font-weight:700">${pSign(t.profit)}${t.profit.toFixed(2)}</td>
        <td style="font-size:10px;color:var(--muted2)">${fmtTime(t.close_time)}</td>
      </tr>`;
    });
    html += `</tbody></table></div>`;
  }
  html += `</div></div>`;

  el.innerHTML = html;
}

function pubTab(tab, code, btn) {
  ['open','history'].forEach(t => {
    const el = $(`pub-${t}-${code}`);
    if (el) el.style.display = t === tab ? 'block' : 'none';
  });
  btn.closest('.sub-tabs').querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

// â”€â”€ Auto-refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(() => {
  const visible = document.querySelector('.page-body[style*="block"]');
  if (!visible) return;
  if (visible.id === 'tab-dashboard') loadDashboard();
}, 10000);

setInterval(updateVPSBanner, 30000);

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (TOKEN) enterApp();
</script>
</body>
</html>
